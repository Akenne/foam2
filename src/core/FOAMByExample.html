<html>
 <head>
  <script language="javascript" src="stdlib.js"></script>
  <script language="javascript" src="mm.js"></script>
  <script language="javascript" src="debug.js"></script>
  <title>FOAM By Example</title>
  <style>
    code {color:blue;}
  </style>
 </head>

 <body style="font-family:monospace;">

<script id='demo' language="xjavascript">
// Define a new class with foam.CLASS
foam.CLASS({
  name: 'Test',
  properties: [
    // short-form
    'a',
    // long-form
    {
      name: 'b'
    }
  ],
  methods: [
    // short-form
    function f1() { return 1; },
    // long-form
    {
      name: 'f2',
      code: function() { return 2; }
    }
  ]
});
log(Test);

// Use class.describe() to learn about the class
Test.describe();

// Create an instance of Test
var o = Test.create();
log(o);
log(o.a, o.b);

// Create an instance with a map argument to initialize properties
var o = Test.create({a:1, b:'foo'});
log(o.a, o.b);

// Objects have a reference to their class in .cls_
log(o.cls_.name);

// Call Methods
log(o.f1(), o.f2());

// Update Properties
o.a++;
o.b = 'bar';
log(o.a, o.b);

// Call toString on an object
log(o.toString());

// Call describe() on an object to see its Property values
o.describe();

// Properties and Methods are types of Axioms
// Find an Axiom for a class using getAxiomByName
log(Test.getAxiomByName('a'));

// Find all Axioms of a particular class using getAxiomsByClass
log(Test.getAxiomsByClass(Method));

// Properties are defined on the class as constants
log(Method.NAME);
Method.NAME.describe();

// Property constants contain map functions
log(Test.getAxiomsByClass(Method).map(Method.NAME.f));

// Property constants contain comparators
log(Test.getAxiomsByClass(Method).sort(Method.NAME.compare).map(Method.NAME.f));

// Default Values can be defined for Properties
foam.CLASS({
  name: 'DefaultValueTest',
  properties: [
    { name: 'a', defaultValue: 42 },
    { name: 'b', defaultValue: 'foo' },
    { name: 'c' }
  ]
});
var o = DefaultValueTest.create();
log(o.a, o.b, o.c);

// .hasOwnProperty() tells you if a Property has been set
log(o.hasOwnProperty('a'), o.hasOwnProperty('b'), o.hasOwnProperty('c'));
o.a = 99;
o.b = 'bar';
o.c = 'test';
log(o.hasOwnProperty('a'), o.hasOwnProperty('b'), o.hasOwnProperty('c'));

// .clearProperty() reverts a value back to its defaultValue
log(o.hasOwnProperty('a'), o.a);
o.clearProperty('a');
log(o.hasOwnProperty('a'), o.a);

// Objects support publish() for publishing events,
// and subscribe() for listening for published events.
foam.CLASS({
  name: 'PubSubTest'
});
var o = PubSubTest.create();
// Install a listener that listens to all events
o.subscribe(function() { console.log('global listener: ', [].join.call(arguments, ' ')); });
o.subscribe('alarm', function() { console.log('fire: ', [].join.call(arguments, ' ')); });
o.publish('alarm', 'on');
o.publish('lifecycle', 'loaded');

// A Class can declare 'Topics' that it publishes events for.
foam.CLASS({
  name: 'TopicTest',
  topics: [ 'alarm' ]
});
var o = TopicTest.create();
o.subscribe('alarm', function(state) { console.log('fire: ', state); });
// The next line uses the Topic and is slightly shorter than the equivalent above.
o.alarm.subscribe(function(state) { console.log('fire: ', state); });
o.publish('on');

// Objects implicitly publish events on the 'propertyChange' topic when
foam.CLASS({
  name: 'TopicTest',
  properties: [ 'a', 'b' ]
});
// Listen for all propertyChange events:
o.propertyChange.subscribe(function(sub, p, name, dyn) { console.log('propertyChange: ', p, name, dyn.getPrev(), dyn.get()); });
// Listen for only changes to the 'a' Property:
o.propertyChange.subscribe('a', function(sub, p, name, dyn) { console.log('propertyChange.a: ', p, name, dyn.getPrev(), dyn.get()); });
o.a = 42;
o.b = 'bar';
o.a++;

</script>

  <div id='output'></div>

  <script language="javascript">
    var demo = document.getElementById('demo');
    var out  = document.getElementById('output');
    var log_ = function(o) {
      if ( o.indexOf('<') != 0 ) o = o.replace(/\n/g, '<br>').replace(/ /g,'&nbsp;');
//      out.innerHTML = out.innerHTML + o + '<br/>';
      document.body.insertAdjacentHTML('beforeend', o + '<br/>');
    }
    var oldLog = console.log;
    console.log = function() { log_([].join.call(arguments, ' ')); };
    console.log.put = console.log.bind(console);
    console.log.str = oldLog.str;
    console.log.json = oldLog.json;
    var log = function() { log_(' <b>&gt;</b> ' + [].join.call(arguments, ' ')); }

    var s = demo.textContent.split('\n\n');
    for ( var i = 0 ; i < s.length ; i++ ) {
      var l = s[i];
      log_(' <h3>Test ' + (i+1) + '</h3><code>' + l + '</code><br>');
      eval(l);
      log_('');
    }
  </script>

 </body>
</html>
